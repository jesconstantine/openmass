<project name="mass-build" default="status">

    <!-- Target: mass-run-eslint  -->
    <target name="mass-run-eslint" description="Checks custom JS code against ESLint.">
        <!-- custom modules  -->
        <exec command="eslint 'web/modules/custom/**/*.js'" checkreturn="true" logoutput="true" />
        <!-- custom themes (ignoring mayflower artifacts) -->
        <exec command="eslint  --ignore-pattern 'web/themes/custom/mass_theme/js/*' 'web/themes/custom/**/*.js' "
              checkreturn="true" logoutput="true" />
        <echo>ESLint was successful</echo>
    </target>

  <target name="mass-drupal-test" description="Run Drupal tests.">
      <property name="build.test_output" value="/dev/null" />

      <if>
          <available file="${build.test_output}" type="dir" />
          <then>
              <property name="behat.args" value="--strict --format=junit --out=${build.test_output}/behat" />
          </then>
          <else>
              <property name="behat.args" value="" />
          </else>
      </if>

      <exec command="vendor/bin/behat ${behat.args}" checkreturn="true" logoutput="true" />
  </target>

  <!-- Target: install-from-acquia -->
  <target name="install-from-acquia" description="Use the Acquia stage environment for installation.">
      <!-- Configure the 'drush' Phing task. -->
      <taskdef name="drush" classname="Drush\Task" />
      <property name="drush.bin" value="${build.dir}/vendor/bin/drush" />
      <property name="drush.config" value="${build.dir}/conf/drushrc.php" />
      <property name="drush.include" value="${build.dir}/artifacts/acquiacloud/.drush" />
      <property name="drush.alias-path" value="${build.dir}/artifacts/acquiacloud/.drush" />

      <if>
          <not><available file="${build.dir}/artifacts/acquiacloud" type="dir" /></not>
          <then>
              <!-- Whitespace is significant within this <echo> -->
              <echo>Acquia Cloud credentials are required for deployment.
          1. Log in to your Acquia account
          2. Navigate to the "Credentials" tab under your profile
          3. Under the "Drush Integration" heading, click the "Download Drush aliases" link
          4. This will download acquiacloud.tar.gz
          5. Unzip this archive
          6. Place the resulting directory within this project's "artifacts" directory
          7. You should now have your Acquia Cloud credentials available at "${build.dir}/artifacts/acquiacloud"</echo>
              <fail message="Acquia Cloud credentials missing." />
          </then>
      </if>

      <if>
        <not><available file="${acquia.databases}" type="dir" /></not>
        <then>
          <echo>Created a database working directory at: ${acquia.databases}.</echo>
          <mkdir dir="${acquia.databases}" />
        </then>
      </if>

      <!-- Which environment will we be pulling from? -->
      <property name="deploy.site_alias" value="@massgov.test" />
      <input propertyname="deploy.site_alias" validargs="@massgov.dev,@massgov.test">Acquia environment to pull from? </input>

      <!-- Which environment will we be pulling from? -->
      <input propertyname="deploy.backup_local_database" validargs="yes,no" defaultValue="no">Backup your local database? </input>

      <input propertyname="deploy.db_sanitize" validargs="yes,no" defaultValue="yes">Sanitize your local database? </input>

      <if>
          <istrue value="${deploy.backup_local_database}" />
          <then>
            <tstamp><format pattern="%Y-%m-%d_%H-%M-%S" property="build.time">  </format></tstamp>
            <exec command="drush --nocolor --yes sql-dump > ${acquia.databases}/backup-db-${build.time}.sql" />
            <echo>Local database backed up to ${acquia.databases}/backup-db-${build.time}.sql</echo>
          </then>
          <else>
            <echo>Skipping local database backup.</echo>
          </else>
      </if>

      <!-- This cannot be a drush command because we cannot run it with the
           root parameter... exec works okay for this one-off. -->
      <echo>Downloading the database from Acquia.</echo>
      <exec command="drush --nocolor --yes ${deploy.site_alias} sql-dump > ${acquia.databases}/remote-db.sql" />
      <drush command="sql-drop" assume="yes" />
      <drush command="sql-cli &lt; ${acquia.databases}/remote-db.sql" />

      <!-- DB is installed! We can remove the file now. -->
      <delete file="${acquia.databases}/remote-db.sql" />

      <if>
        <istrue value="${deploy.db_sanitize}" />
        <then>
          <echo>Preforming local database operations.</echo>
          <!-- Scrub the DB of PII & reset the admin password. -->
          <drush command="sql-sanitize" assume="yes">
            <option name="sanitize-password">admin</option>
            <option name="sanitize-email">user+%uid@localhost</option>
          </drush>

          <drush command="upwd">
            <option name="password">admin</option>
            <param>admin</param>
          </drush>
        </then>
      </if>

      <echo>Reticulating splines.</echo>
      <drush command="cr" />

      <!-- Now that we have the database, we need to rsync files down. -->
      <!-- Sync the files directory -->
      <!-- The SSH user. -->
      <echo>Preparing for file sync.</echo>
      <drush command="site-alias" returnProperty="deploy.host">
          <param>${deploy.site_alias}</param>
          <option name="format" value="csv" />
          <option name="fields" value="remote-host" />
      </drush>

      <!-- The SSH host. -->
      <drush command="site-alias" returnProperty="deploy.username">
          <param>${deploy.site_alias}</param>
          <option name="format" value="csv" />
          <option name="fields" value="remote-user" />
      </drush>

      <!-- The Acquia docroot. -->
      <drush command="site-alias" returnProperty="deploy.drupal.root">
          <param>${deploy.site_alias}</param>
          <option name="format" value="csv" />
          <option name="fields" value="root" />
      </drush>

      <property name="deploy.file_source" value="${deploy.username}@${deploy.host}:${deploy.drupal.root}/files" />
      <property name="deploy.file_dest" value="${build.dir}/${drupal.root}/${drupal.settings.file_public_path}" />

      <echo>Syncing files.</echo>
      <filesync
           sourcedir="${deploy.file_source}"
           destinationdir="${deploy.file_dest}"
           options="-rltDvPh" />

      <drush command="cimy" assume="yes">
        <option name="source" value="/var/www/mass.local/conf/drupal/config" />
        <option name="delete-list" value="/var/www/mass.local/conf/drupal/delete.yml" />
      </drush>

      <echo>Running `drush updb` now.</echo>
      <drush command="updb" assume="yes" />

  </target>

  <target name="mass-local-modules" description="Install local modules.">
    <drush command="pm-enable" assume="yes">
        <param>devel</param>
        <param>kint</param>
        <param>mass_types</param>
        <param>mass_utility</param>
        <param>migrate_tools</param>
    </drush>
  </target>

  <target name="mass-set-api-keys" description="Update API Keys.">
    <fail unless="api_keys.google.maps" />

    <!-- Rewrite the theme registry. -->
    <if>
      <available file="${build.dir}/web/themes/custom/mass_admin_theme/mass_admin_theme.libraries.yml" type="file" />
      <then>
        <echo>Updating the Google Maps API Key in the theme file.</echo>

        <copy
          file="${build.dir}/conf/mass_admin_theme.libraries.yml.template"
          tofile="${build.dir}/web/themes/custom/mass_admin_theme/mass_admin_theme.libraries.yml"
          overwrite="true">
            <filterchain>
                <replacetokens begintoken="{{" endtoken="}}">
                    <token key="placeholder-key" value="${api_keys.google.maps}" />
                </replacetokens>
            </filterchain>
        </copy>
      </then>
    </if>
  </target>

</project>

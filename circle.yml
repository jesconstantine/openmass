machine:
  hosts:
    mass.local: 127.0.0.1
  php:
    version: 5.6.14
  node:
    version: 0.12.17
  environment:
    PALANTIR_ENVIRONMENT: circle
    PATH: ${HOME}/${CIRCLE_PROJECT_REPONAME}/vendor/bin:$PATH
    DB_DB: circle_test
    DB_USER: ubuntu
    DB_PASS:

dependencies:
  pre:
    - cp $HOME/$CIRCLE_PROJECT_REPONAME/conf/apache.circle.conf /etc/apache2/sites-available/default
    - sed -e "s?%PROJECT_DIR%?$(pwd)?g" --in-place /etc/apache2/sites-available/default
    - sudo a2enmod rewrite
    - echo "sendmail_path=/bin/true" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
    - echo "memory_limit=256M" > ~/.phpenv/versions/$(phpenv global)/etc/conf.d/memory.ini
    - sudo service apache2 restart
    # Generate a GitHub token per project and add it to the CircleCI environment variables using the web UI.
    - composer config --global github-oauth.github.com $GITHUB_TOKEN


  override:
    - composer install --no-interaction
    - npm install -g eslint@v2.13.1

  cache_directories:
    - ~/.composer/cache

test:
  pre:
    - cd web && drush -yv sql-sync @massgov.prod @self
    - cd web && drush -y rsync @massgov.prod:%files @self:%files
    - cd web && drush -yv updatedb
    - cd web && drush -yv --include=../vendor/previousnext/drush_cmi_tools cimy

  override:
    - phing test
